{% extends "base.html" %}
{% include "badge.html" %}

{% set breadcrumb_items = [
{'title': 'Anathema', 'url': url_for('bans.a_front')},
{'title': 'Appeals', 'url': url_for('bans.appeals_index')},
{'title': 'Appeal #' ~ ban.uid, 'url': url_for('bans.view_appeal', uid=ban.uid)}]
%}

{% set current_page = 'bans' %}

{% block content %}
<div class="container">
    {%- if not ban.active %}
    <div class="row">
        <div class="span12">
            <div class="alert alert-info">
                <span>Ban was removed{% if ban.removed_time != None %} on {{ ban.removed_time.strftime("%H:%M %d %b %y") }}{% endif %}{% if ban.removed_by != None %} by {{ ban.removed_by or 'unknown' }}{% endif %}.</span>
            </div>
        </div>
    </div>
    {%- endif %}
    <div class="row">
        <div class="span12">
            <div class="box">
                {%- if is_mod and ban.active %}
                <div id="admin-form">
                    {#<table>
                        <tr>
                            <td>
                                Unlock:
                            </td>
                            <td>
                                <input class="datepicker" id="unlock-date" type="text" value="{% if appeal.unlock_time %}{{ appeal.unlock_time.strftime('%m/%d/%Y') }}{% endif %}">
                            </td>
                            <td>
                                <input id="unlock-date-set" type="submit" value="Set">
                            </td>
                            <td>
                                <input id="unlock-date-remove" type="submit" value="Remove">
                            </td>
                        </tr>
                        <tr>
                            <td>
                                Remove ban:
                            </td>
                            <td>
                                <input class="datepicker" id="unban-date" type="text" value="{% if ban.removed_time %}{{ ban.removed_time.strftime('%m/%d/%Y') }}{% endif %}">
                            </td>
                            <td>
                                <input id="unban-date-set" type="submit" value="Set">
                            </td>
                            <td>
                                <input id="unban-date-remove" type="submit" value="Remove">
                            </td>
                        </tr>
                    </table>#}
                    <a class="btn btn-danger" href="{{ url_for('bans.unban_ban_id', uid=ban.uid) }}">Unban Now</a>
                </div>
                <br>
                {%- endif %}
                <div id="ban-info">
                    {%- if locked %}
                    <p>Appeal is locked.</p>
                    <br>
                    {%- endif %}
                    <p><strong>Banned by {{ ban.issuer }} with the reason:</strong></p>
                    <em>{{ ban.reason }}</em>
                </div>
            </div>
        </div>
    </div>
    {#<div class="row" style="margin-bottom: 15px">
        <div class="span12">
            <div class="pull-right">
                {%- if current_user.is_authenticated() %}
                <a class="btn btn-small" type="submit" href="#post-reply">Post New Reply</a>
                {%- endif %}
            </div>
        </div>
    </div>#}
    {%- for reply in replies %}
    {%- if not reply.hidden or current_user.has_permission('bans.appeal.show_hidden') %}
    <div id="{{ reply.uid }}" class="row post-root">
        <div class="span12">
            <div class="box" style="padding: 0 6px 10px 6px;{% if reply.hidden %}background-color: #dddddd;{% endif %}">
                <div class="row-fluid nobreak">
                    <div class="span12" style="border-bottom: 1px solid #{% if reply.hidden %}e9e9e9{% else %}dddddd{% endif %}; padding-left: 2px; padding-top: 5px; padding-bottom: 5px;">
                        <div class="pull-left">
                            <span>by <a href="{{ reply.creator.get_profile_url() }}">{{ reply.creator.name }}</a>
                            {%- if reply.creator.name|lower == ban.issuer|lower %}
                            | Ban Issuer
                            {%- endif %}
                            {%- if reply.creator.name|lower == ban.username|lower %}
                            | Ban Appealer
                            {%- endif %}
                            {%- if reply.creator.has_permission("bans.appeal.manage") %}
                            | Moderator
                            {%- endif %}
                            </span>
                        </div>
                        <div class="pull-right">
                            <a href="#{{ reply.uid }}">permalink</a>
                            {%- if current_user.is_authenticated() %}
                            <a class="quote-link" href="#">quote</a>
                            {%- endif %}
                            {%- if is_mod %}
                            <a href="{{ url_for('bans.edit_reply', uid=reply.uid) }}" class="edit-link">edit</a>
                            <a href="{{ url_for('bans.hide_reply', uid=reply.uid, hide=(not reply.hidden)) }}" class="post-manage-link">{% if reply.hidden %}unhide{% else %}hide{% endif %}</a>
                            {%- endif %}
                        </div>
                    </div>
                </div>
                <div class="row-fluid" style="margin-bottom: 0;">
                    <div class="span2 forum-post-left"><img src="{{ url_for('avatar.get_avatar', name=reply.creator.name) }}" /></div>
                    <div class="span10 forum-post-right">
                        <div class="forum-post-rendered">{{ reply.text|markdown|safe }}</div>
                        <div class="forum-post-raw">{{ reply.text|escape }}</div>
                        <div class="forum-post-edit">
                            <form action="{{ url_for('bans.edit_reply', uid=reply.uid) }}" method="post">
                                {{ reply_form.hidden_tag() }}
                                <div class="widget">
                                    <textarea name="text"></textarea>
                                </div>
                                <button class="btn btn-theme" type="submit">Submit</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {%- endif %}
    {%- endfor %}
    {%- if is_mod or (current_user.name|lower == ban.username|lower and not locked) %}
    <div id="post-reply" class="row">
        <div class="span12">
            <div class="box">
                <label for="text">Reply</label>
                <form method="post" action="{{ url_for('bans.post_appeal_reply', uid=ban.uid) }}" style="margin-bottom:0;">
                    {{ reply_form.hidden_tag() }}
                    {%- if reply_form.errors %}
                    <div class="widget">
                        {%- for error_field in reply_form.errors.values() %}
                        {%- for error in error_field %}
                        <div class="alert alert-error">
                            <button type="button" class="close" data-dismiss="alert">×</button>
                            {{ error }}
                        </div>
                        {%- endfor %}
                        {%- endfor %}
                    </div>
                    {%- endif %}
                    <div class="widget">
                        {{ reply_form.text(class="input-block-level", placeholder="Appeal body") }}
                    </div>
                    <div class="widget">
                        <button class="btn btn-theme btn-small pull-left marginright5" id="submit" name="submit" type="submit">Submit</button>
                        <p class="pull-left"><a href="#format-help-modal" role="button" data-toggle="modal">Formatting help?</a></p>
                    </div>
                    <div class="clear"></div>
                </form>
            </div>
        </div>
    </div>
    {%- endif %}
</div>
<div id="format-help-modal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="format-help-modal-label" aria-hidden="true">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h3 id="myModalLabel">Markdown Help</h3>
    </div>
    <div class="modal-body">
        <p>Junction uses a version of Markdown for formatting, much like reddit. Here are some basics to get ya started.</p>
        <table class="table table-bordered table-condensed table-striped">
            <thead>
                <tr>
                    <th class="span6">
                        You Type
                    </th>
                    <th class="span6">
                        You Get
                    </th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>*italics*</td>
                    <td><em>italics</em></td>
                </tr>
                <tr>
                    <td>**bold**</td>
                    <td><strong>bold</strong></td>
                </tr>
                <tr>
                    <td>[link](https://junction.at)</td>
                    <td><a href="https://junction.at">link</a></td>
                </tr>
                <tr>
                    <td>![catz](http://i.imgur.com/FudN96H.jpg)</td>
                    <td><img alt="catz" src="http://i.imgur.com/FudN96H.jpg"></td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
{#<script>
    $(function() {
        $('.datepicker').datepicker({'minDate' : 0});
    });
</script>
<script>
    $(function() {
        function animate_flick(element, color) {
            element.css('background-color', color);
            element.animate({
                backgroundColor: '#eeeeee'
            }, 1000, null);
        };
        function animate_error_flick(element) {
            animate_flick(element, '#cc5533')
        };
        function animate_success_flick(element) {
            animate_flick(element, '#55cc33');
        };
        $('#unban-date-set').click(function(event) {
            $.ajax({
                type: 'POST',
                url: "{{ url_for('bans.set_unban_date', uid=ban.uid) }}",
                data: {set: true, date: $('#unban-date').val()},
                dataType: "text",
                success: function(result) {
                    if(result == 'SUCCESS') {
                        animate_success_flick($('#admin-form'));
                    } else {
                        animate_error_flick($('#admin-form'));
                        alert(result);
                    }
                },
                error: function(result) {
                    animate_error_flick($('#admin-form'));
                }
            });
        });
        $('#unban-date-remove').click(function(event) {
            $.ajax({
                type: 'POST',
                url: "{{ url_for('bans.set_unban_date', uid=ban.uid) }}",
                data: {remove: true},
                dataType: "text",
                success: function(result) {
                    if(result == 'SUCCESS') {
                        animate_success_flick($('#admin-form'));
                        $('#unban-date').val('');
                    } else {
                        animate_error_flick($('#admin-form'));
                        alert(result);
                    }
                },
                error: function(result) {
                    animate_error_flick($('#admin-form'));
                }
            });
        });
        $('#unlock-date-set').click(function(event) {
            $.ajax({
                type: 'POST',
                url: "{{ url_for('bans.set_unlock_date', uid=ban.uid) }}",
                data: {set: true, date: $('#unlock-date').val()},
                dataType: "text",
                success: function(result) {
                    if(result == 'SUCCESS') {
                        animate_success_flick($('#admin-form'));
                    } else {
                        animate_error_flick($('#admin-form'));
                        alert(result);
                    }
                },
                error: function(result) {
                    animate_error_flick($('#admin-form'));
                }
            });
        });
        $('#unlock-date-remove').click(function(event) {
            $.ajax({
                type: 'POST',
                url: "{{ url_for('bans.set_unlock_date', uid=ban.uid) }}",
                data: {remove: true},
                dataType: "text",
                success: function(result) {
                    if(result == 'SUCCESS') {
                        animate_success_flick($('#admin-form'));
                        $('#unlock-date').val('');
                    } else {
                        animate_error_flick($('#admin-form'));
                        alert(result);
                    }
                },
                error: function(result) {
                    animate_error_flick($('#admin-form'));
                }
            });
        });
    });
</script>
<script>
    $(function() {
        $('.post-hide-button').click(function(e) {
            $(e.target).prev('.hide-element').fadeToggle();
        });
    });
</script>#}
{% endblock %}

{% block css %}
    <link href="/static/css/forum.css" rel="stylesheet">
{% endblock %}
{% block javascript %}
    <script src="/static/js/forum.js"></script>
{% endblock %}
